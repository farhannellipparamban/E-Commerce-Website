<%- include("../layouts/userPartials/header.ejs") %>

  <style>

    .checkout_area {
      padding: 50px 0;
    }

    .order_box {
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .coupon_box,
    .wallet_box {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .coupon_box h2,
    .wallet_box h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .coupon_input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .coupon_button,
    .wallet_button {
      margin-top: 10px;
      padding: 8px 15px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    .billing_details {
      padding-top: 20px;
    }

    .billing_details h3 {
      font-size: 24px;
      margin-bottom: 15px;
    }

    .modal-header {
      background-color: #ff0000;
      color: white;
    }

    .coupon-code {
      padding: 10px 16px;
      margin-bottom: 15px;
      background-color: #f8f8f8;
      color: #000000;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .coupon-code:hover {
      transform: translateY(-3px);
      box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
    }

    .coupons-list {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }

    .no-coupon {
      display: block;
      text-align: center;
      font-size: 18px;
      color: #ca0000;
    }

    .btn-close {
      color: #000000;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .btn-close:hover {
      opacity: 1;
      color: rgb(255, 255, 255);
    }

    .modal-footer {
      border-top: 1px solid #dfd9d9;
      padding: 10px;
    }

    .modal-footer .btn-secondary {
      background-color: #ff0000;
      border-color: #000000;
      color: #fffafa;
      transition: background-color 0.3s ease;
    }

    .modal-footer .btn-secondary:hover {
      background-color: #8d8a8a;
    }

    .modal-footer .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      transition: background-color 0.3s ease;
    }

    .modal-footer .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn {
      border-radius: 30px;
      background-color: #ff0000;
    }

    .coupons-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .coupon {
      background-color: #f9f9f9;
      border: 1px solid #c5c3c3;
      border-radius: 5px;
      padding: 10px;
      width: 300px;
    }

    .coupon-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coupon-code {
      font-size: 18px;
      font-weight: bold;
    }

    .coupon-type {
      font-size: 16px;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .percentage-off {
      background-color: #1ac70a;
      color: white;
    }

    .fixed-off {
      background-color: #ff0000;
      color: white;
    }

    .coupon-details {
      margin-top: 10px;
      font-size: 14px;
      color: #000000;
    }

    .no-coupon {
      font-size: 16px;
      font-weight: bold;
      color: #f00;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }

 
    .checkout-main {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .checkout-container {
      background-color: #ffffff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 5px;
      width: 100%;
      max-width: 95%;
      padding: 50px;
      margin-left: 30px;
    }

 
    .coupon-input-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #code {
      flex: 1;
      padding: 10px;
      border: 1px solid #d60000;
      border-radius: 5px;
      margin-right: 10px;
    }

    #wallet {
      flex: 1;
      padding: 10px;
      border: 1px solid #d60000;
      border-radius: 5px;
      margin-right: 10px;
    }

    .apply-coupon-btn {
      background-color: #ff0000;
      color: #fff;
      border: none;
      border-radius: 45px;
      padding: 10px;
      cursor: pointer;
    }

    .wallet-btn {
      background-color: #ff0000;
      color: #fff;
      border: none;
      border-radius: 45px;
      padding: 10px 20px;
      cursor: pointer;
    }

    .apply-coupon-btn:hover {
      opacity: 1;
      background-color: rgb(54, 54, 54);
    }

    .wallet-btn:hover {
      opacity: 1;
      background-color: rgb(41, 41, 41);
    }

    .billing-title {
      font-size: 24px;
      font-weight: bold;
      margin-top: 50px;
      margin-bottom: 40px;
      color: #333;
    }

    .add-address-btn {
      background-color: #ff0000;
      color: #fff;
      border: none;
      border-radius: 45px;
      padding: 20px 30px;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
    }

    .add-address-btn:hover {
      background-color: #8d8a8a;
      
    }

    .address-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .address-item {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .address-item:hover {
      background-color: #f8f8f8;
    }

    .address-details {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .address-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .address-info {
      display: flex;
      flex-direction: column;
    }

    .address-field {
      margin-right: 50px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .address-field span {
      font-weight: bold;
      margin-right: 5px;
      color: #000000;
    }

    .address-item-input[type="radio"] {
      margin-right: 10px;
    }

    .edit-btn,
    .delete-btn {
      background-color: #ff0000;
      color: #fff;
      border: none;
      border-radius: 45px;
      margin-bottom: 0;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .edit-btn:hover,
    .delete-btn:hover {
      background-color: #8d8a8a;
    }

    .order-box {
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .order-box h2 {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 60px;
      color: #000000;
    }

    .order-title {
      font-size: 24px;
      font-weight: bold;
      color: #000000;
    }

    .order-list {
      list-style-type: none;
      padding: 0;
    }

    .order-list li {
      margin-bottom: 10px;
    }

    .order-list a {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      color: #333;
      text-decoration: none;
    }

    .order-list span {
      font-family: math;
      color: #000000;
    }

    .payment-methods {
      margin-top: 30px;
    }

    .payment-methods label {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      display: block;
    }

    .payment-option {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .payment-option input[type="radio"] {
      margin-right: 10px;
    }

    .payment-option label {
      font-size: 16px;
      color: #333;
      cursor: pointer;
    }

    .place-order-btn {
      background-color: #ff0000;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 15px 30px;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .place-order-btn:hover {
      background-color: #8d8a8a;
    }


    .wallet-section {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-top: 20px;
    }

    .wallet-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .wallet-info {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: 500;
    }

    .wallet-label {
      margin-right: 10px;
    }

    .wallet-amount {
      color: #ff0000;
    }
  </style>

  <main>
    <!-- Hero Area Start-->
    <div class="slider-area ">
      <div class="single-slider slider-height2 d-flex align-items-center">
        <div class="container">
          <div class="row">
            <div class="col-xl-12">
              <div class="hero-cap text-center">
                <h2>Checkout</h2>
                <p>A watch is a daily reminder that time is ticking away. Make the most of today</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!--================Checkout Area =================-->
    <section class="checkout_area section_padding">
      <div class="checkout-container">
        <div class="order_box col-lg-4"> 
          <!-- Button trigger modal --> 
          <button type="button"
            class="btn py-4 mb-5 circle arrow" data-bs-toggle="modal" data-bs-target="#exampleModal"> Available Coupons
          </button>
          <!-- Modal -->
          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5 text-white" id="exampleModalLabel">Available Coupons</h1>
                  <div type="button" class="btn-close" data-bs-dismiss="modal" aria-label="x-icon"><svg
                      xmlns="http:www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-x"
                      viewBox="0 0 16 16">
                      <path
                        d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                    </svg></div>
                </div>
                <div class="modal-body">
                  <div class="coupons-list">
                    <% if (coupons && coupons.length> 0) { %>
                      <% coupons.forEach(coupon=> { %>
                        <div class="coupon">
                          <div class="coupon-header"> <span class="coupon-code">
                              <%= coupon.code %>
                            </span> <span
                              class="coupon-type <%= coupon.discountType === 'Percentage Type' ? 'percentage-off' : 'fixed-off' %>">
                              <% if (coupon.discountType==='Percentage Type' ) { %>
                                <%= coupon.discountAmount %>% Off <% } else { %>
                                    <%= coupon.discountAmount %> Off <% } %>
                            </span> </div>
                          <div class="coupon-details">
                            <p>Expires: <%= coupon.expiryDate.toISOString().substring(0, 10) %>
                            </p>
                            <p>Balance: <%= coupon.maxUsers %> uses</p>
                          </div>
                        </div>
                        <% }) %>
                          <% } else { %> <span class="no-coupon">No Coupon Available!</span>
                            <% } %>
                  </div>

                </div>
                <div class="modal-footer"> <button type="button" class="btn btn-secondary py-4"
                    data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <h2>Coupon</h2>
 
          <form id="coupon-form">
            <div class="cart-coupon">
              <input type="text" id="code" name="cart-coupon" placeholder="Coupon code">
              <button type="submit" class="apply-coupon-btn  success circle arrow">Apply Coupon</button>
            </div>
          </form>
          <div class="wallet-section">
            <h5 class="wallet-title" data-bs-toggle="collapse" data-bs-target="#faq-item-2-2" aria-expanded="true">
              Available Wallet Money
            </h5>
            <div class="wallet-info"> <span class="wallet-label">Wallet:</span>
              <span id="walletbalance" class="wallet-amount">₹<%= userd.wallet %></span>
            </div>
          </div>

      


          <label for="wallet"></label> <input type="text" name="wallet" id="wallet" placeholder="Enter Wallet Amount"
            required> <button class="wallet-btn btn_4 success circle arrow"
            onclick="walamount($('#wallet').val())">Add</button>

        </div>

        <div class="billing-details">
          <div class="row">
            <div class="col-lg-8">
              <h3 class="billing-title">Billing Address</h3>
              <hr>
              <br>

              <a class="add-address-btn" href="/addAddresscheck">ADD ADDRESS</a>
              <br>
              <br><br>
              <form id="checkout">
                <% if (typeof address !=="undefined" ) { %>
                  <div class="address-list">
                    <% address.forEach((value, index)=> { %>
                      <div class="address-item">
                        <input class="form-check-input" name="address" type="radio" id="flexCheckDefault<%= index %>"
                          value="<%= value.fname %> <%= value.sname %> <%= value.address %> <%= value.mobile %> <%= value.email %> <%= value.city %> <%= value.pin %>"
                          required>
                        <label class="form-check-label" for="flexCheckDefault<%= index %>">
                          <div class="address-details">
                            <div class="address-name">
                              <%= value.fname %>
                                <%= value.sname %>
                            </div>
                            <div class="address-info">
                              <div class="address-field"><span>Address:</span>
                                <%= value.address %>
                              </div>
                              <div class="address-field"><span>Phone:</span>
                                <%= value.mobile %>
                              </div>
                              <div class="address-field"><span>Email:</span>
                                <%= value.email %>
                              </div>
                              <div class="address-field"><span>City:</span>
                                <%= value.city %>
                              </div>
                              <div class="address-field"><span>PIN:</span>
                                <%= value.pin %>
                              </div>
                            </div>
                          </div>
                        </label>
                      </div>
                      <br>
                      <div style="display: flex;">
                        <div>
                          <a class="genric-btn edit-btn"
                            href="/editAddresscheck?id=<%=value._id%>&index=<%=index%>">Edit</a>
                        </div>
                        <div style="margin-left: 10px;">
                          <a class="genric-btn delete-btn" href="/deleteAddressCheckout?id=<%=value._id%>">Delete</a>
                        </div>
                      </div>
                      <hr>
                      <% })%>
                  </div>
                  <% }%>

            </div>
            <div class="col-lg-4">
              <div class="order-box">
                <h2>Your Order Payment Details-</h2>
                <hr>
                <ul class="order-list">
                  <li>
                    <a>Subtotal
                      <span id="total2">
                        <%= Total %>
                      </span>
                    </a>
                  </li>
                  <li>
                    <a>Coupon Amount <span id="coupon"></span>
                    </a>
                  </li>
                  <input type="hidden" name="grand" id="hide" value="<%= Total - userd.wallet %>">
                  <li>
                    <a>Grand Total
                      <span id="total1">
                        <%= Total %>
                      </span>
                    </a>
                  </li>
                </ul>
                <div class="payment-methods">
                  <label for="Payment">Select Payment Method:</label>
                  <div class="payment-option">
                    <input type="radio" id="payment-cod" name="Payment" value="COD" required>
                    <label for="Payement">Cash On Delivery</label>
                  </div>
                  <div class="payment-option">
                    <input type="radio" id="payment-wallet" name="Payment" value="wallet" required>
                    <label for="Payement">Wallet</label>
                  </div>
                  <div class="payment-option">
                    <input type="radio" id="payment-online" name="Payment" value="online" required> <label
                      for="Payement">Online Payment</label>
                  </div>
                </div>
                <button class="place-order-btn" type="submit">Place Order</button>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!--================End Checkout Area =================-->


  <script>
    $("#checkout").submit((e) => {

      const amount = document.getElementById("total1").innerHTML;
      const amount2 = document.getElementById("total2").innerHTML;
      const walletamount = document.getElementById("wallet").innerHTML;
      const coupon1 = document.getElementById('coupon').innerHTML;
      const grand1 = amount2 - hide
      let address = $("input[name=address]:checked").val();
      let payment = $("input[name=Payment]:checked").val();

      e.preventDefault();
      $.ajax({
        url: "/checkout",
        method: "post",
        data: {
          amount: amount,
          total: amount2,
          address: address,
          payment: payment,
          wallet: walletamount,
          coupon: coupon1
        },
        success: (response) => {
          if (response.success === false) {
            Swal.fire({
              title: "Error",
              icon: "error",
              text: response.message,
              timer: 2000,
            });
          }
          else if (response.codsuccess) {
            location.href = "/orderplaced";
          } else {
            razorpayPayment(response.orders);
          }
        }
      })
    })

    function razorpayPayment(order) {
      var options = {
        "key": "rzp_test_X5XhJ53T3zS8E9",   
        "amount": order.amount,             
        "currency": "INR",
        "name": "Clocksy Watches",       
        "description": "Test Transaction",
        "image": "https://example.com/your_logo",
        "order_id": order.id,               
        "handler": function (response) {
          verifyPayment(response, order); 
        },
        "prefill": {                        
          "name": "Gaurav Kumar",         
          "email": "gaurav.kumar@example.com",
          "contact": "9000090000"         
        },
        "notes": {
          "address": "Razorpay Corporate Office"
        },
        "theme": {
          "color": "#FF0000"
        }
      };
      var rzp1 = new Razorpay(options);
      rzp1.open();
    }


    function verifyPayment(payment, order) {
      $.ajax({
        url: '/verifyPayment',
        method: 'post',
        data: {
          payment,
          order,
        },
        success: (response) => {
          if (response.success) {
            window.location.href = '/orderplaced';
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: "Payment Failed"
            })
          }
        }
      })
    }

  

  </script>


  <script>
    $("#coupon-form").submit((e) => {
      e.preventDefault();
      const code = $("#code").val();
      const amount = $("#total1").text();
      console.log(amount);
      $.ajax({
        url: "/applyCoupon",
        method: "post",
        data: {
          code: code,
          amount: amount
        },

        success: (response) => {
          if (response.user) {
            Swal.fire({
              icon: 'warning',
              title: 'Oops...',
              text: 'Oops! This user has already used this coupon'
            })
          } else if (response.limit) {
            Swal.fire({
              icon: 'warning',
              title: 'Oops...',
              text: "Oops! Coupon limit exceeded"
            })
          } else if (response.status) {
            Swal.fire({
              icon: 'warning',
              title: 'Oops...',
              text: "Oops! This coupon is not in use"
            })
          } else if (response.cartAmount) {
            Swal.fire({
              icon: 'warning',
              title: 'Oops...',
              text: "Oops! You can't use the coupon... Buy more"
            })
          } else if (response.date) {
            Swal.fire({
              icon: 'warning',
              title: 'Oops...',
              text: 'Oops! Coupon date expired'
            })

          } else if (response.amountOkey) {
            document.getElementById('coupon').innerText = response.disAmount;
            document.getElementById('total1').innerText = response.disTotal;
            Swal.fire({
              position: 'center',
              icon: 'success',
              title: 'Coupon Added',
              showConfirmButton: false,
              timer: 1500
            })
          } else if (response.invalid) {
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'Oops! Invalid coupon'
            })
          }
        }
      });
    });

  </script>

  <script>
    function walamount(wallet) {

      const subTotal = document.getElementById('total2').innerHTML
      const grandTotal = document.getElementById('total1').innerHTML

      $.ajax({
        url: "/wallet",
        data: {
          wallet: wallet,
          grandTotal: grandTotal,
          subTotal: subTotal
        },
        method: 'post',

        success: (response) => {

          if (response.limit) {

            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'Wallet limit exceeded!'
            })

          } else {
            document.getElementById('wallet').innerHTML = response.wallet
            document.getElementById('total1').innerHTML = response.grandTotal
            document.getElementById('walletbalance').innerHTML = response.totalwallet - response.wallet
            Swal.fire({
              position: 'center',
              icon: 'success',
              title: 'Wallet Amount Added',
              showConfirmButton: false,
              timer: 1500
            })
          }

        }

      })
    }
  </script>
  <%- include("../layouts/userPartials/footer.ejs") %>